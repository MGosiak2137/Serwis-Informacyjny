{% extends "nav_foot_eco.html" %}
{% block header %}
<link rel="stylesheet" href="{{ url_for('currencies.static', filename='stockmarket.css') }}">
<script src="{{ url_for('currencies.static', filename='script.js') }}" defer></script>
{% endblock %}
{% block main %}
<main class="page-main">
  <section id="home" class="stockmarket-section">
    <header class="sm-hero">
      <h2>{{ title or "Giełda — przegląd rynku" }}</h2>
      <p style="font-size:0.9em;color:#666;">Ostatnia aktualizacja: {{ update_time or 'n/d' }} (odświeżanie co 60 sekund)</p>
    </header>

    <div class="sm-tabs" style="margin:1rem 0;display:flex;gap:0.5rem;align-items:center;">
      <button id="tab-category" class="tab-btn active" onclick="showTab('category')">Kategoria</button>
      <button id="tab-options" class="tab-btn" onclick="showTab('options')">Opcje</button>
      <button id="tab-results" class="tab-btn" onclick="showTab('results')">Wyniki</button>
    </div>

    <div id="tab-content-category" class="tab-panel">
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        {% for cat in categories %}
          <a class="category-link" href="/stockmarket?category={{ cat }}&range={{ current_range }}">
            {{ cat }}
          </a>
        {% endfor %}
      </div>
      <div style="margin-top:0.75rem;color:#666;font-size:0.9rem;">Kliknij kategorię, aby zobaczyć dostępne opcje.</div>
    </div>

    <div id="tab-content-options" class="tab-panel" style="display:none;margin-top:1rem;">
      <div style="color:#666;">Użyj lewego panelu (Options) aby wybrać symbole — po wyborze nastąpi przekierowanie do Wyników.</div>
    </div>

    <div id="tab-content-results" class="tab-panel" style="display:none;margin-top:1rem;">
      <div style="color:#666;margin-bottom:0.5rem;">Po załadowaniu symboli, tutaj pojawią się wyniki.</div>
    </div>

    <div class="sm-grid">
      <div class="sm-left">
        <div id="left-options" style="margin-bottom:1rem;">
          {% if options_for_category %}
            <form id="options-form" onsubmit="event.preventDefault(); loadSelected();">
              <div style="display:flex;flex-direction:column;gap:0.5rem;">
                <label style="font-weight:600;color:#333;">Wybierz symbol (można wybrać maksymalnie 1):</label>
                <select id="select-symbols" name="symbol" style="width:100%;padding:0.45rem 0.5rem;border-radius:6px;border:1px solid #ccc;font-size:0.95rem;">
                  <option value="" disabled selected>— wybierz symbol —</option>
                  {% for opt in options_for_category %}
                    <option value="{{ opt.symbol }}" {% if selected_symbols and opt.symbol == selected_symbols[0] %}selected{% endif %}>{{ opt.name }} ({{ opt.symbol }})</option>
                  {% endfor %}
                </select>
                <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
                  <button type="button" id="load-selected-btn" class="btn-primary">Załaduj wybrane</button>
                  <a href="/stockmarket{% if selected_category %}?category={{ selected_category }}{% endif %}" class="btn-secondary">Wyczyść wybór</a>
                </div>
              </div>
            </form>
          {% else %}
            <div style="color:#666;">Wybierz kategorię, aby zobaczyć opcje.</div>
          {% endif %}
        </div>

        <aside class="sm-cards" id="left-cards">
          {% set current_category = "" %}
          {% for r in rates %}
            {% if r.category != current_category %}
              {% if current_category != "" %}</div>{% endif %}
              <div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #ddd;">
                <h4 style="margin:0 0 0.75rem 0;font-size:0.95rem;color:#666;">{{ r.category }}</h4>
              </div>
              {% set current_category = r.category %}
            {% endif %}
            <div class="index-card {% if selected_symbols %}disabled-card{% endif %}" {% if not selected_symbols %}onclick="toggleChart('{{ r.symbol }}')" role="button" tabindex="0"{% else %}role="button" tabindex="0"{% endif %} data-symbol="{{ r.symbol }}">
              <div class="index-left">
                <div class="index-name">{{ r.name }}</div>
                <div class="index-code muted-code">{{ r.code }}</div>
              </div>
              <div class="index-right">
                <div class="index-price">{% if r.price is defined and r.price %}{{ "%.2f"|format(r.price) }} {{ r.currency or '' }}{% else %}n/d{% endif %}</div>
                <div class="index-rate {% if r.rate.startswith('+') %}positive{% elif r.rate.startswith('-') %}negative{% endif %}">{{ r.rate }}</div>
                <div class="market-badge {% if r.is_open %}open{% else %}closed{% endif %}">{{ "OTWARTA" if r.is_open else "ZAMKNIĘTA" }}</div>
              </div>
            </div>
          {% endfor %}
        </aside>

        {% if intraday_data %}
        <div class="intraday-section" id="left-intraday" style="margin-top:1rem;">
          {% for symbol, data_list in intraday_data.items() %}
            <article id="intraday-{{ symbol }}" style="display:none;margin-bottom:1rem;border:1px solid #eee;padding:0.75rem;border-radius:6px;">
              <h4 style="margin:0 0 0.5rem 0;">{{ symbol }} — Dane intraday (ostatnie 5 interwałów)</h4>
              <table style="width:100%;border-collapse:collapse;font-size:0.9em;">
                <thead><tr style="background:#f5f5f5"><th style="padding:0.4rem;text-align:left;">Godz.</th><th style="padding:0.4rem;text-align:right;">Close</th></tr></thead>
                <tbody>
                  {% for row in data_list %}
                    <tr><td style="padding:0.35rem;">{{ row.time }}</td><td style="padding:0.35rem;text-align:right;">{{ row.close }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </article>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <div class="sm-right">
        {% if historical_data %}
        <div class="charts-section">
          <div class="range-buttons">
            <a href="/stockmarket?range=5d{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_symbols %}&symbols={{ selected_symbols|join(',') }}{% endif %}" data-range="5d" class="range-btn {% if current_range == '5d' %}active{% endif %}">Ostatni tydzień</a>
            <a href="/stockmarket?range=1mo{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_symbols %}&symbols={{ selected_symbols|join(',') }}{% endif %}" data-range="1mo" class="range-btn {% if current_range == '1mo' %}active{% endif %}">Ostatni miesiąc</a>
            <a href="/stockmarket?range=1y{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_symbols %}&symbols={{ selected_symbols|join(',') }}{% endif %}" data-range="1y" class="range-btn {% if current_range == '1y' %}active{% endif %}">Ostatni rok</a>
          </div>
          {% for symbol, chart_info in historical_data.items() %}
            {% if chart_info.data %}
              <div class="chart-container" id="chart-{{ symbol }}" style="display:none;">
                <div id="chart-inner-{{ symbol }}">
                  <h4>{{ symbol }} — Wykres historyczny</h4>
                  <div style="position:relative;margin-top:1rem;">
                    <svg viewBox="0 0 1100 520" preserveAspectRatio="none" style="width:100%;height:520px;border:1px solid #eee;">
                      <defs>
                        <linearGradient id="grad-{{ symbol }}" x1="0" x2="1" y1="0" y2="1">
                          <stop offset="0%" stop-color="rgba(0,123,255,0.3)"/>
                          <stop offset="100%" stop-color="rgba(0,123,255,0.05)"/>
                        </linearGradient>
                      </defs>
                      <g stroke="#e0e0e0" stroke-width="0.5">
                        {% for i in range(0,11) %}<line x1="80" y1="{{ i*52 }}" x2="1100" y2="{{ i*52 }}" />{% endfor %}
                        {% for i in range(0,11) %}<line x1="{{ 80+(i*102) }}" y1="0" x2="{{ 80+(i*102) }}" y2="520" />{% endfor %}
                      </g>
                      <line x1="80" y1="520" x2="1100" y2="520" stroke="#333" stroke-width="2" />
                      <line x1="80" y1="0" x2="80" y2="520" stroke="#333" stroke-width="2" />
                      <g font-size="11" fill="#666" text-anchor="end">
                        {% set price_range = chart_info.max - chart_info.min %}
                        {% for i in range(0,11) %}{% set price = chart_info.min + (price_range*(10-i)/10) %}<text x="75" y="{{ i*52+5 }}">{{ "%.2f" % price }} {{ currency }}</text>{% endfor %}
                      </g>
                      <g font-size="10" fill="#666" text-anchor="middle">
                        {% if chart_info.data|length>0 %}
                          {% set step=(chart_info.data|length/10)|int %}{% if step<1 %}{% set step=1 %}{% endif %}
                          {% for i in range(0, chart_info.data|length, step) %}{% set x_pos=80+((i/(chart_info.data|length-1))*1020) if chart_info.data|length>1 else 590 %}<text x="{{ x_pos }}" y="540">{{ chart_info.data[i].date[-5:] }}</text>{% endfor %}
                        {% endif %}
                      </g>
                      {% if chart_info.min != chart_info.max %}
                        {% set price_range=chart_info.max-chart_info.min %}
                        <polyline points="{% for row in chart_info.data %}{{ 80 + (loop.index0/(chart_info.data|length-1))*1020 if chart_info.data|length>1 else 590 }},{{ 520 - ((row.close-chart_info.min)/price_range*520) }}{% if not loop.last %} {% endif %}{% endfor %}" fill="none" stroke="#007bff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                      {% endif %}
                    </svg>
                  </div>
                  <div style="font-size:0.95em;color:#666;margin-top:0.75rem;">Min: {{ "%.2f" % chart_info.min }} {{ currency }} | Max: {{ "%.2f" % chart_info.max }} {{ currency }} | Punktów danych: {{ chart_info.data|length }}</div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="sm-ticker" aria-live="polite"><div class="ticker-track" id="live-ticker"></div></div>

    <div id="stockmarket-init" data-selected-category="{{ selected_category or '' }}" data-current-range="{{ current_range or '' }}" data-selected-symbols="{{ selected_symbols|join(',') if selected_symbols else '' }}" style="display:none;"></div>
  </section>
</main>
{% endblock %}
