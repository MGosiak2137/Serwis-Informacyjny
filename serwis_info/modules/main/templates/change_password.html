{% extends "template.html" %}

{% block title %}Zmień hasło{% endblock %}

{% block body_class %}change-password-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/auth_layout.css') }}">
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/auth_common.css') }}">
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/password_features.css') }}">
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/form_validation.css') }}">
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/change_password.css') }}">
{% endblock %}

{% block content %}
  <div class="login-container">
    <div class="login-card">
      <h1>Zmień hasło</h1>
      <p class="text-muted">
        Wprowadź obecne hasło oraz wybierz nowe, bezpieczne hasło.
      </p>

      {# Display flash messages including success messages inside the card #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-3">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mb-2" role="alert">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form method="POST" action="{{ url_for('main.change_password') }}">
        {{ form.hidden_tag() }}
        
        <div class="mb-3">
          <label class="form-label">Obecne hasło</label>
          <div class="password-input-wrapper">
            {{ form.current_password(class_="form-control password-input", placeholder="Wprowadź obecne hasło", id="current-password") }}
            <button type="button" class="password-toggle-btn" id="current-password-toggle" aria-label="Pokaż/ukryj hasło">
              <i class="bi bi-eye" id="current-password-icon"></i>
            </button>
          </div>
          {% for error in form.current_password.errors %}
            <div class="invalid-feedback">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label class="form-label">Nowe hasło</label>
          <div class="password-input-wrapper">
            {{ form.new_password(class_="form-control password-input", placeholder="Wprowadź nowe hasło", id="new-password") }}
            <button type="button" class="password-toggle-btn" id="new-password-toggle" aria-label="Pokaż/ukryj hasło">
              <i class="bi bi-eye" id="new-password-icon"></i>
            </button>
          </div>
          <div class="password-strength-meter" id="password-strength-meter">
            <div class="password-strength-bar" id="password-strength-bar"></div>
          </div>
          <div class="password-requirements" id="password-requirements">
            <small class="text-muted">Wymagania dotyczące hasła:</small>
            <ul class="password-requirements-list">
              <li id="req-length" class="requirement-item">
                <i class="bi bi-x-circle requirement-icon"></i>
                <span>Minimum 8 znaków</span>
              </li>
              <li id="req-uppercase" class="requirement-item">
                <i class="bi bi-x-circle requirement-icon"></i>
                <span>Przynajmniej jedna wielka litera</span>
              </li>
              <li id="req-lowercase" class="requirement-item">
                <i class="bi bi-x-circle requirement-icon"></i>
                <span>Przynajmniej jedna mała litera</span>
              </li>
              <li id="req-number" class="requirement-item">
                <i class="bi bi-x-circle requirement-icon"></i>
                <span>Przynajmniej jedna cyfra</span>
              </li>
              <li id="req-special" class="requirement-item">
                <i class="bi bi-x-circle requirement-icon"></i>
                <span>Przynajmniej jeden znak specjalny (!@#$%^&*)</span>
              </li>
            </ul>
          </div>
          {% for error in form.new_password.errors %}
            <div class="invalid-feedback">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label class="form-label">Powtórz nowe hasło</label>
          <div class="password-input-wrapper">
            {{ form.new_password2(class_="form-control password-input", placeholder="Powtórz nowe hasło", id="new-password2") }}
            <button type="button" class="password-toggle-btn" id="new-password2-toggle" aria-label="Pokaż/ukryj hasło">
              <i class="bi bi-eye" id="new-password2-icon"></i>
            </button>
          </div>
          <div class="password-match-indicator" id="password-match-indicator">
            <small id="password-match-text"></small>
          </div>
          {% for error in form.new_password2.errors %}
            <div class="invalid-feedback">{{ error }}</div>
          {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary">
          Zmień hasło
        </button>

        <div class="change-password-links">
          <a href="{{ url_for('main.account_settings') }}" class="change-password-link">
            <i class="bi bi-arrow-left me-1"></i>Powrót do ustawień konta
          </a>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const newPassword2Input = document.getElementById('new-password2');
    const currentPasswordToggle = document.getElementById('current-password-toggle');
    const newPasswordToggle = document.getElementById('new-password-toggle');
    const newPassword2Toggle = document.getElementById('new-password2-toggle');
    const currentPasswordIcon = document.getElementById('current-password-icon');
    const newPasswordIcon = document.getElementById('new-password-icon');
    const newPassword2Icon = document.getElementById('new-password2-icon');
    
    // Password visibility toggles
    function setupToggle(input, btn, icon) {
      if (input && btn) {
        btn.addEventListener('click', function() {
          const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
          input.setAttribute('type', type);
          
          if (type === 'text') {
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
          } else {
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
          }
        });
      }
    }
    
    setupToggle(currentPasswordInput, currentPasswordToggle, currentPasswordIcon);
    setupToggle(newPasswordInput, newPasswordToggle, newPasswordIcon);
    setupToggle(newPassword2Input, newPassword2Toggle, newPassword2Icon);
    
    // Password validation rules
    const requirements = {
      length: { regex: /.{8,}/, element: document.getElementById('req-length') },
      uppercase: { regex: /[A-Z]/, element: document.getElementById('req-uppercase') },
      lowercase: { regex: /[a-z]/, element: document.getElementById('req-lowercase') },
      number: { regex: /[0-9]/, element: document.getElementById('req-number') },
      special: { regex: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/, element: document.getElementById('req-special') }
    };
    
    // Password strength calculation
    function calculatePasswordStrength(password) {
      let strength = 0;
      let metRequirements = 0;
      
      Object.keys(requirements).forEach(key => {
        if (requirements[key].regex.test(password)) {
          strength += 20;
          metRequirements++;
        }
      });
      
      // Bonus for length
      if (password.length >= 12) strength += 10;
      if (password.length >= 16) strength += 10;
      
      return { strength: Math.min(strength, 100), metRequirements };
    }
    
    // Update requirement indicators
    function updateRequirements(password) {
      Object.keys(requirements).forEach(key => {
        const req = requirements[key];
        const icon = req.element.querySelector('.requirement-icon');
        const isMet = req.regex.test(password);
        
        if (isMet) {
          icon.classList.remove('bi-x-circle', 'text-danger');
          icon.classList.add('bi-check-circle', 'text-success');
          req.element.classList.add('requirement-met');
        } else {
          icon.classList.remove('bi-check-circle', 'text-success');
          icon.classList.add('bi-x-circle', 'text-danger');
          req.element.classList.remove('requirement-met');
        }
      });
    }
    
    // Update strength meter
    function updateStrengthMeter(strength) {
      const strengthBar = document.getElementById('password-strength-bar');
      const strengthMeter = document.getElementById('password-strength-meter');
      
      if (!strengthBar || !strengthMeter) return;
      
      strengthBar.style.width = strength + '%';
      
      // Update color based on strength
      strengthBar.classList.remove('strength-weak', 'strength-fair', 'strength-good', 'strength-strong');
      strengthMeter.classList.remove('strength-weak', 'strength-fair', 'strength-good', 'strength-strong');
      
      if (strength < 40) {
        strengthBar.classList.add('strength-weak');
        strengthMeter.classList.add('strength-weak');
      } else if (strength < 60) {
        strengthBar.classList.add('strength-fair');
        strengthMeter.classList.add('strength-fair');
      } else if (strength < 80) {
        strengthBar.classList.add('strength-good');
        strengthMeter.classList.add('strength-good');
      } else {
        strengthBar.classList.add('strength-strong');
        strengthMeter.classList.add('strength-strong');
      }
    }
    
    // Check password match
    function checkPasswordMatch() {
      const matchIndicator = document.getElementById('password-match-indicator');
      const matchText = document.getElementById('password-match-text');
      
      if (!newPasswordInput || !newPassword2Input || !matchIndicator || !matchText) return;
      
      const password = newPasswordInput.value;
      const password2 = newPassword2Input.value;
      
      if (password2.length === 0) {
        matchIndicator.style.display = 'none';
        return;
      }
      
      matchIndicator.style.display = 'block';
      
      if (password === password2) {
        matchText.textContent = '✓ Hasła się zgadzają';
        matchText.className = 'text-success';
        newPassword2Input.classList.remove('is-invalid');
        newPassword2Input.classList.add('is-valid');
      } else {
        matchText.textContent = '✗ Hasła się nie zgadzają';
        matchText.className = 'text-danger';
        newPassword2Input.classList.remove('is-valid');
        newPassword2Input.classList.add('is-invalid');
      }
    }
    
    // Real-time password validation
    if (newPasswordInput) {
      newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        const { strength, metRequirements } = calculatePasswordStrength(password);
        
        updateRequirements(password);
        updateStrengthMeter(strength);
        
        // Update input border color
        if (metRequirements === 5 && password.length >= 8) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else if (password.length > 0) {
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        } else {
          this.classList.remove('is-valid', 'is-invalid');
        }
        
        // Check match if second password is filled
        if (newPassword2Input && newPassword2Input.value.length > 0) {
          checkPasswordMatch();
        }
      });
    }
    
    // Real-time password match checking
    if (newPassword2Input) {
      newPassword2Input.addEventListener('input', checkPasswordMatch);
    }
    
    // Form submission validation
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const password = newPasswordInput.value;
        const password2 = newPassword2Input.value;
        const { metRequirements } = calculatePasswordStrength(password);
        
        // Check all requirements are met
        if (metRequirements < 5 || password.length < 8) {
          e.preventDefault();
          alert('Hasło nie spełnia wszystkich wymagań bezpieczeństwa. Sprawdź listę wymagań powyżej.');
          newPasswordInput.focus();
          return false;
        }
        
        // Check passwords match
        if (password !== password2) {
          e.preventDefault();
          alert('Hasła się nie zgadzają. Upewnij się, że oba hasła są identyczne.');
          newPassword2Input.focus();
          return false;
        }
      });
    }
  });
</script>
{% endblock %}
