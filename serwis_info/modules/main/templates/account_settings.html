{% extends "template.html" %}

{% block title %}Ustawienia konta{% endblock %}

{% block body_class %}account-settings-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/account_settings.css') }}">
<link rel="stylesheet" href="{{ url_for('main.static', filename='auth/delete_account_modal.css') }}">
{% endblock %}

{% block content %}
  <div class="login-container">
    <div class="account-settings-card">
      <h1>Ustawienia konta</h1>
      <p class="text-muted">
        Zarządzaj swoim kontem i preferencjami.
      </p>

      {# Display flash messages including success messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-3">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mb-2" role="alert">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="account-info">
        <div class="account-info-item">
          <span class="account-info-label">Nazwa użytkownika:</span>
          <span class="account-info-value">{{ current_user.nickname }}</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">Adres e-mail:</span>
          <span class="account-info-value">{{ current_user.email }}</span>
        </div>
        <div class="account-info-item">
          <span class="account-info-label">Data utworzenia konta:</span>
          <span class="account-info-value">
            {% if current_user.created_at %}
              {{ current_user.created_at.strftime('%d.%m.%Y o %H:%M') }}
            {% else %}
              Nieznana
            {% endif %}
          </span>
        </div>
      </div>

      <div class="account-actions">
        <a href="{{ url_for('main.change_password') }}" class="change-password-btn">
          <i class="bi bi-key me-2"></i>Zmień hasło
        </a>
        <a href="{{ url_for('auth.logout') }}" class="logout-btn">
          Wyloguj się
        </a>
        
        <button type="button" class="delete-account-btn" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
          Usuń konto
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-danger">
          <h5 class="modal-title text-danger" id="deleteAccountModalLabel">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>Usuń konto
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger" role="alert">
            <strong>Uwaga!</strong> Ta operacja jest <strong>nieodwracalna</strong>.
          </div>
          <p class="mb-3">Czy na pewno chcesz usunąć swoje konto?</p>
          <p class="text-muted mb-3">Wszystkie Twoje dane zostaną trwale usunięte i nie będzie możliwości ich odzyskania.</p>
          <p class="mb-2"><strong>Aby potwierdzić, wpisz "DELETE" w polu poniżej:</strong></p>
          <input 
            type="text" 
            id="deleteConfirmationInput" 
            class="form-control" 
            placeholder="Wpisz DELETE aby potwierdzić"
            autocomplete="off"
          >
          <small class="text-muted d-block mt-2">Musisz wpisać dokładnie "DELETE" (wielkimi literami) aby móc usunąć konto.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
          <form action="{{ url_for('main.delete_account') }}" method="POST" style="display: inline;" id="deleteAccountForm">
            <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>
              <i class="bi bi-trash-fill me-1"></i>Usuń konto
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Delete account modal functionality
    const modal = document.getElementById('deleteAccountModal');
    const confirmationInput = document.getElementById('deleteConfirmationInput');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteAccountForm = document.getElementById('deleteAccountForm');
    
    // Reset input when modal is opened
    if (modal) {
      modal.addEventListener('show.bs.modal', function() {
        confirmationInput.value = '';
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.classList.remove('btn-danger');
        confirmDeleteBtn.classList.add('btn-secondary');
      });
    }
    
    // Validate input in real-time
    if (confirmationInput) {
      confirmationInput.addEventListener('input', function() {
        const inputValue = this.value.trim();
        if (inputValue === 'DELETE') {
          confirmDeleteBtn.disabled = false;
          confirmDeleteBtn.classList.remove('btn-secondary');
          confirmDeleteBtn.classList.add('btn-danger');
          confirmationInput.classList.remove('is-invalid');
          confirmationInput.classList.add('is-valid');
        } else {
          confirmDeleteBtn.disabled = true;
          confirmDeleteBtn.classList.remove('btn-danger');
          confirmDeleteBtn.classList.add('btn-secondary');
          if (inputValue.length > 0) {
            confirmationInput.classList.remove('is-valid');
            confirmationInput.classList.add('is-invalid');
          } else {
            confirmationInput.classList.remove('is-valid', 'is-invalid');
          }
        }
      });
    }
    
    // Prevent form submission if input is invalid
    if (deleteAccountForm) {
      deleteAccountForm.addEventListener('submit', function(e) {
        if (confirmationInput.value.trim() !== 'DELETE') {
          e.preventDefault();
          alert('Musisz wpisać "DELETE" aby potwierdzić usunięcie konta.');
          return false;
        }
        
        // Final confirmation
        if (!confirm('Ostatnie potwierdzenie: Czy na pewno chcesz trwale usunąć swoje konto? Ta operacja jest nieodwracalna.')) {
          e.preventDefault();
          return false;
        }
      });
    }

  });
</script>
{% endblock %}

